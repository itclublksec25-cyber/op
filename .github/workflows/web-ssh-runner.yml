name: VSCode Web Runner

on:
  workflow_dispatch:

jobs:
  code:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - name: Update system
      run: sudo apt update

    - name: Install code-server
      run: |
        curl -fsSL https://code-server.dev/install.sh | sh
        mkdir -p ~/.config/code-server
        cat <<EOF > ~/.config/code-server/config.yaml
bind-addr: 0.0.0.0:8080
auth: none
cert: false
EOF

    - name: Start code-server
      run: |
        nohup code-server > /dev/null 2>&1 &

    - name: Install Tailscale
      run: |
        curl -fsSL https://tailscale.com/install.sh | sh
        sudo tailscale up --authkey=${{ secrets.TSKEY }} --hostname=code-runner

    - name: Enable Funnel for VSCode Web
      run: |
        sudo tailscale funnel 8080
        tailscale funnel status

    - name: Keep alive
      run: sleep infinity
