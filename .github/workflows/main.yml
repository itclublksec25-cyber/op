name: Browser Desktop via Tailscale Funnel

on:
  workflow_dispatch:

jobs:
  desktop:
    runs-on: ubuntu-latest

    steps:
      - name: Update packages
        run: sudo apt update -y

      # 1️⃣  Install Tailscale
      - name: Install Tailscale
        run: curl -fsSL https://tailscale.com/install.sh | sh

      - name: Authenticate Tailscale
        run: sudo tailscale up --authkey=${{ secrets.TS_KEY }} --hostname=Browser-Desktop

      # 2️⃣  Desktop & VNC
      - name: Install XFCE + VNC stack
        run: |
          sudo apt install -y xfce4 x11vnc novnc websockify
          # start a display
          export DISPLAY=:0
          sudo x11vnc -create -forever -shared -rfbport 5900 &
          # bridge VNC to WebSockets
          sudo websockify --web=/usr/share/novnc/ 8080 localhost:5900 &

      # 3️⃣  Tailscale Funnel setup
      - name: Enable Tailscale Funnel
        run: |
          sudo tailscale serve --https 443 localhost:8080
          sudo tailscale funnel 443 on
          echo "Your public URL (when running) will look like:"
          tailscale serve status

      # 4️⃣  Keep Runner Alive
      - name: Keep session alive
        run: sleep 999999
